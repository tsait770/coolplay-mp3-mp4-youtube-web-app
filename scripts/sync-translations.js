#!/usr/bin/env node
/*
  Sync translation keys across l10n/*.json
  - Uses en.json as base (fallback) if present
  - Ensures every locale has the union of keys
  - Fills missing values from base, preserves existing values
  - Writes a summary to translation_missing_report.md
*/

const fs = require('fs');
const path = require('path');

const L10N_DIR = path.resolve(process.cwd(), 'l10n');
const REPORT_FILE = path.resolve(process.cwd(), 'translation_missing_report.md');

function readJSON(fp) {
  return JSON.parse(fs.readFileSync(fp, 'utf8'));
}

function writeJSON(fp, obj) {
  const sorted = Object.keys(obj)
    .sort((a, b) => a.localeCompare(b))
    .reduce((acc, k) => { acc[k] = obj[k]; return acc; }, {});
  fs.writeFileSync(fp, JSON.stringify(sorted, null, 2) + '\n', 'utf8');
}

function main() {
  if (!fs.existsSync(L10N_DIR)) {
    console.error(`[sync] l10n directory not found at ${L10N_DIR}`);
    process.exit(1);
  }

  const files = fs.readdirSync(L10N_DIR).filter(f => f.endsWith('.json'));
  if (files.length === 0) {
    console.error('[sync] No locale JSON files found in l10n/');
    process.exit(1);
  }

  const locales = files.map(f => ({
    file: f,
    code: f.replace(/\.json$/, ''),
    path: path.join(L10N_DIR, f),
    data: readJSON(path.join(L10N_DIR, f)),
  }));

  const base = locales.find(l => l.code === 'en') || locales[0];
  const baseKeys = new Set(Object.keys(base.data));
  const allKeys = new Set();
  locales.forEach(l => Object.keys(l.data).forEach(k => allKeys.add(k)));
  baseKeys.forEach(k => allKeys.add(k));

  const summary = [];

  locales.forEach(l => {
    const beforeCount = Object.keys(l.data).length;
    let missing = 0;
    for (const key of allKeys) {
      if (!(key in l.data)) {
        l.data[key] = base.data[key] ?? base.data[key] ?? '';
        missing++;
      }
    }
    writeJSON(l.path, l.data);
    const afterCount = Object.keys(l.data).length;
    summary.push({ code: l.code, before: beforeCount, after: afterCount, missing });
  });

  const reportLines = [
    `# Translation Sync Report`,
    `Date: ${new Date().toISOString()}`,
    `Base locale: ${base.code}`,
    `Total keys: ${allKeys.size}`,
    '',
    '| Locale | Before | After | Filled Missing |',
    '|--------|--------|-------|----------------|',
    ...summary.map(s => `| ${s.code} | ${s.before} | ${s.after} | ${s.missing} |`),
    '',
    '_Auto-generated by scripts/sync-translations.js_',
  ];
  fs.writeFileSync(REPORT_FILE, reportLines.join('\n') + '\n', 'utf8');

  console.log('[sync] Completed translation key sync. Summary:');
  summary.forEach(s => {
    console.log(` - ${s.code}: +${s.missing} missing keys filled (${s.before} -> ${s.after})`);
  });
}

main();