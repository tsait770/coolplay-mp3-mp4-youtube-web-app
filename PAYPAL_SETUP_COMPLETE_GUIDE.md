# PayPal è®¢é˜…ç³»ç»Ÿå®Œæ•´è®¾ç½®æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [åˆ›å»º PayPal å¼€å‘è€…è´¦æˆ·](#1-åˆ›å»º-paypal-å¼€å‘è€…è´¦æˆ·)
2. [åˆ›å»º PayPal App å’Œè·å–å‡­è¯](#2-åˆ›å»º-paypal-app-å’Œè·å–å‡­è¯)
3. [åˆ›å»ºè®¢é˜…äº§å“å’Œè®¡åˆ’](#3-åˆ›å»ºè®¢é˜…äº§å“å’Œè®¡åˆ’)
4. [é…ç½®ç¯å¢ƒå˜é‡](#4-é…ç½®ç¯å¢ƒå˜é‡)
5. [æµ‹è¯• PayPal é›†æˆ](#5-æµ‹è¯•-paypal-é›†æˆ)
6. [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#6-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
7. [å¸¸è§é—®é¢˜](#7-å¸¸è§é—®é¢˜)

---

## 1. åˆ›å»º PayPal å¼€å‘è€…è´¦æˆ·

### æ­¥éª¤ 1.1: æ³¨å†Œ PayPal å¼€å‘è€…è´¦æˆ·

1. è®¿é—® **PayPal Developer Portal**:
   ```
   https://developer.paypal.com
   ```

2. ç‚¹å‡»å³ä¸Šè§’çš„ **"Log In"** æˆ– **"Sign Up"**

3. å¦‚æœå·²æœ‰ PayPal ä¸ªäºº/å•†ä¸šè´¦æˆ·ï¼Œå¯ä»¥ç›´æ¥ç™»å½•
   - å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª PayPal è´¦æˆ·

4. ç™»å½•åï¼Œä¼šè‡ªåŠ¨è¿›å…¥ PayPal Developer Dashboard

### æ­¥éª¤ 1.2: éªŒè¯è´¦æˆ·

1. åœ¨ Dashboard å·¦ä¾§å¯¼èˆªæ ï¼Œç‚¹å‡» **"Apps & Credentials"**
2. å¦‚æœçœ‹åˆ°æç¤ºéœ€è¦éªŒè¯é‚®ç®±ï¼Œè¯·å‰å¾€é‚®ç®±å®ŒæˆéªŒè¯
3. éªŒè¯å®Œæˆåï¼Œå¼€å‘è€…åŠŸèƒ½å°†å®Œå…¨è§£é”

---

## 2. åˆ›å»º PayPal App å’Œè·å–å‡­è¯

### æ­¥éª¤ 2.1: åˆ›å»º Sandbox App

1. åœ¨ **Apps & Credentials** é¡µé¢
2. ç¡®ä¿é¡¶éƒ¨é€‰æ‹©äº† **"Sandbox"** ç¯å¢ƒ (å¼€å‘æµ‹è¯•ç¯å¢ƒ)
3. ç‚¹å‡» **"Create App"** æŒ‰é’®

4. å¡«å†™åº”ç”¨ä¿¡æ¯:
   - **App Name**: `InstaPlay Sandbox` (æˆ–ä»»æ„åç§°)
   - **App Type**: é€‰æ‹© **"Merchant"** (å•†å®¶)
   - ç‚¹å‡» **"Create App"**

### æ­¥éª¤ 2.2: è·å– Sandbox å‡­è¯

åˆ›å»ºå®Œæˆåï¼Œä½ ä¼šçœ‹åˆ°:

```
Client ID: AXXXXXXXxxxxxxxxxxxxXXXXXXXXXX
Secret: EXXXXXXXxxxxxxxxxxxxXXXXXXXXXX
```

**é‡è¦**: 
- âœ… **Client ID** æ˜¯å…¬å¼€çš„ï¼Œå¯ä»¥åœ¨å‰ç«¯ä½¿ç”¨
- âš ï¸ **Secret** æ˜¯ç§å¯†çš„ï¼Œåªèƒ½åœ¨åç«¯ä½¿ç”¨ï¼Œä¸è¦æ³„éœ²

**è®°å½•è¿™ä¸¤ä¸ªå€¼**ï¼Œç¨åä¼šç”¨åˆ°ã€‚

### æ­¥éª¤ 2.3: é…ç½® App åŠŸèƒ½

åœ¨ App è®¾ç½®é¡µé¢ï¼Œå‘ä¸‹æ»šåŠ¨åˆ° **"Features"** éƒ¨åˆ†:

1. ç¡®ä¿ä»¥ä¸‹åŠŸèƒ½å·²å¯ç”¨:
   - âœ… **Subscriptions** (è®¢é˜…åŠŸèƒ½)
   - âœ… **Payments** (æ”¯ä»˜åŠŸèƒ½)

2. å¦‚æœæœªå¯ç”¨ï¼Œç‚¹å‡» **"Add"** æŒ‰é’®å¯ç”¨

3. ç‚¹å‡»é¡µé¢åº•éƒ¨çš„ **"Save"** ä¿å­˜è®¾ç½®

### æ­¥éª¤ 2.4: è·å– Sandbox æµ‹è¯•è´¦æˆ·

1. åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œç‚¹å‡» **"Sandbox" â†’ "Accounts"**

2. PayPal ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªæµ‹è¯•è´¦æˆ·:
   - **Personal Account** (ä¹°å®¶è´¦æˆ·) - ç”¨äºæµ‹è¯•è´­ä¹°è®¢é˜…
   - **Business Account** (å–å®¶è´¦æˆ·) - ç”¨äºæ¥æ”¶ä»˜æ¬¾

3. ç‚¹å‡» **"Personal Account"** çš„ **"..."** æŒ‰é’® â†’ **"View/Edit Account"**

4. è®°å½•ä»¥ä¸‹ä¿¡æ¯:
   - **Email**: sb-xxxxx@personal.example.com
   - **Password**: ç³»ç»Ÿç”Ÿæˆçš„å¯†ç  (ç‚¹å‡» "Show" æŸ¥çœ‹)

**è¿™ä¸ªè´¦æˆ·å°†ç”¨äºæµ‹è¯•è®¢é˜…è´­ä¹°æµç¨‹**

---

## 3. åˆ›å»ºè®¢é˜…äº§å“å’Œè®¡åˆ’

### æ­¥éª¤ 3.1: åˆ›å»ºè®¢é˜…äº§å“

1. ç¡®ä¿ä»åœ¨ **Sandbox** ç¯å¢ƒ
2. è®¿é—® **PayPal Subscriptions API** åˆ›å»ºäº§å“

   **æ–¹æ³• A: ä½¿ç”¨ PayPal Dashboard** (æ¨è)
   
   ä¸å¹¸çš„æ˜¯ï¼ŒPayPal Sandbox ä¸æä¾›å¯è§†åŒ–ç•Œé¢åˆ›å»ºè®¢é˜…ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ APIã€‚

   **æ–¹æ³• B: ä½¿ç”¨ API åˆ›å»º** (ä¸‹é¢è¯¦ç»†è¯´æ˜)

### æ­¥éª¤ 3.2: ä½¿ç”¨ Postman/cURL åˆ›å»ºäº§å“

#### 3.2.1: è·å– Access Token

```bash
curl -v https://api-m.sandbox.paypal.com/v1/oauth2/token \
  -H "Accept: application/json" \
  -H "Accept-Language: en_US" \
  -u "YOUR_CLIENT_ID:YOUR_SECRET" \
  -d "grant_type=client_credentials"
```

**æ›¿æ¢**:
- `YOUR_CLIENT_ID`: æ­¥éª¤ 2.2 ä¸­è·å–çš„ Client ID
- `YOUR_SECRET`: æ­¥éª¤ 2.2 ä¸­è·å–çš„ Secret

**å“åº”ç¤ºä¾‹**:
```json
{
  "access_token": "A21AAxxxxxxxxxxxxxxxxxxxxxx",
  "token_type": "Bearer",
  "expires_in": 32400
}
```

**è®°å½• `access_token`**ï¼Œæœ‰æ•ˆæœŸ 9 å°æ—¶ã€‚

#### 3.2.2: åˆ›å»ºè®¢é˜…äº§å“

```bash
curl -v -X POST https://api-m.sandbox.paypal.com/v1/catalogs/products \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "name": "InstaPlay Subscription",
    "description": "Premium video streaming service with voice control",
    "type": "SERVICE",
    "category": "SOFTWARE",
    "image_url": "https://your-app.com/logo.png",
    "home_url": "https://your-app.com"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "id": "PROD-xxxxxxxxxxxx",
  "name": "InstaPlay Subscription",
  "description": "...",
  "status": "CREATED"
}
```

**è®°å½• Product ID**: `PROD-xxxxxxxxxxxx`

### æ­¥éª¤ 3.3: åˆ›å»ºè®¢é˜…è®¡åˆ’

ç°åœ¨ä¸ºæ¯ä¸ªä¼šå‘˜ç­‰çº§åˆ›å»ºè®¢é˜…è®¡åˆ’ã€‚

#### 3.3.1: Basic æœˆåº¦è®¡åˆ’

```bash
curl -v -X POST https://api-m.sandbox.paypal.com/v1/billing/plans \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "product_id": "PROD-xxxxxxxxxxxx",
    "name": "InstaPlay Basic Monthly",
    "description": "Basic tier with 1500 voice commands per month",
    "billing_cycles": [
      {
        "frequency": {
          "interval_unit": "MONTH",
          "interval_count": 1
        },
        "tenure_type": "REGULAR",
        "sequence": 1,
        "total_cycles": 0,
        "pricing_scheme": {
          "fixed_price": {
            "value": "9.99",
            "currency_code": "USD"
          }
        }
      }
    ],
    "payment_preferences": {
      "auto_bill_outstanding": true,
      "payment_failure_threshold": 3
    }
  }'
```

**å“åº”**:
```json
{
  "id": "P-1AB23456CD789012E",
  "product_id": "PROD-xxxxxxxxxxxx",
  "name": "InstaPlay Basic Monthly",
  "status": "CREATED"
}
```

**è®°å½• Plan ID**: `P-1AB23456CD789012E`

#### 3.3.2: Basic å¹´åº¦è®¡åˆ’

```bash
curl -v -X POST https://api-m.sandbox.paypal.com/v1/billing/plans \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "product_id": "PROD-xxxxxxxxxxxx",
    "name": "InstaPlay Basic Yearly",
    "description": "Basic tier with 1500 voice commands per month, billed annually",
    "billing_cycles": [
      {
        "frequency": {
          "interval_unit": "YEAR",
          "interval_count": 1
        },
        "tenure_type": "REGULAR",
        "sequence": 1,
        "total_cycles": 0,
        "pricing_scheme": {
          "fixed_price": {
            "value": "99.99",
            "currency_code": "USD"
          }
        }
      }
    ],
    "payment_preferences": {
      "auto_bill_outstanding": true,
      "payment_failure_threshold": 3
    }
  }'
```

**è®°å½• Plan ID**: `P-2BC34567DE890123F`

#### 3.3.3: Premium æœˆåº¦è®¡åˆ’

```bash
curl -v -X POST https://api-m.sandbox.paypal.com/v1/billing/plans \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "product_id": "PROD-xxxxxxxxxxxx",
    "name": "InstaPlay Premium Monthly",
    "description": "Premium tier with unlimited voice commands",
    "billing_cycles": [
      {
        "frequency": {
          "interval_unit": "MONTH",
          "interval_count": 1
        },
        "tenure_type": "REGULAR",
        "sequence": 1,
        "total_cycles": 0,
        "pricing_scheme": {
          "fixed_price": {
            "value": "19.99",
            "currency_code": "USD"
          }
        }
      }
    ],
    "payment_preferences": {
      "auto_bill_outstanding": true,
      "payment_failure_threshold": 3
    }
  }'
```

**è®°å½• Plan ID**: `P-3CD45678EF901234G`

#### 3.3.4: Premium å¹´åº¦è®¡åˆ’

```bash
curl -v -X POST https://api-m.sandbox.paypal.com/v1/billing/plans \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "product_id": "PROD-xxxxxxxxxxxx",
    "name": "InstaPlay Premium Yearly",
    "description": "Premium tier with unlimited voice commands, billed annually",
    "billing_cycles": [
      {
        "frequency": {
          "interval_unit": "YEAR",
          "interval_count": 1
        },
        "tenure_type": "REGULAR",
        "sequence": 1,
        "total_cycles": 0,
        "pricing_scheme": {
          "fixed_price": {
            "value": "199.99",
            "currency_code": "USD"
          }
        }
      }
    ],
    "payment_preferences": {
      "auto_bill_outstanding": true,
      "payment_failure_threshold": 3
    }
  }'
```

**è®°å½• Plan ID**: `P-4DE56789FG012345H`

### æ­¥éª¤ 3.4: æ¿€æ´»è®¡åˆ’

åˆ›å»ºåï¼Œè®¡åˆ’çŠ¶æ€ä¸º `CREATED`ï¼Œéœ€è¦æ¿€æ´»æ‰èƒ½ä½¿ç”¨ã€‚

```bash
curl -v -X POST https://api-m.sandbox.paypal.com/v1/billing/plans/P-1AB23456CD789012E/activate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**å¯¹æ‰€æœ‰ 4 ä¸ªè®¡åˆ’é‡å¤æ­¤æ“ä½œ**ã€‚

---

## 4. é…ç½®ç¯å¢ƒå˜é‡

### æ­¥éª¤ 4.1: æ›´æ–° `.env` æ–‡ä»¶

æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ï¼Œå¡«å…¥ä»¥ä¸‹ä¿¡æ¯:

```env
# =====================================================
# PayPal Configuration
# =====================================================
EXPO_PUBLIC_PAYPAL_CLIENT_ID=YOUR_SANDBOX_CLIENT_ID
PAYPAL_CLIENT_SECRET=YOUR_SANDBOX_SECRET
PAYPAL_MODE=sandbox

# PayPal è®¢é˜…è®¡åˆ’ ID
PAYPAL_PLAN_ID_BASIC_MONTHLY=P-1AB23456CD789012E
PAYPAL_PLAN_ID_BASIC_YEARLY=P-2BC34567DE890123F
PAYPAL_PLAN_ID_PREMIUM_MONTHLY=P-3CD45678EF901234G
PAYPAL_PLAN_ID_PREMIUM_YEARLY=P-4DE56789FG012345H

# App URL (ç”¨äºå›è°ƒ)
EXPO_PUBLIC_APP_URL=http://localhost:8081
```

**æ›¿æ¢**:
- `YOUR_SANDBOX_CLIENT_ID`: æ­¥éª¤ 2.2 çš„ Client ID
- `YOUR_SANDBOX_SECRET`: æ­¥éª¤ 2.2 çš„ Secret
- `P-xxxxx`: æ­¥éª¤ 3.3 åˆ›å»ºçš„ Plan IDs

### æ­¥éª¤ 4.2: éªŒè¯ç¯å¢ƒå˜é‡åŠ è½½

```typescript
// åœ¨ä»»æ„ TypeScript æ–‡ä»¶ä¸­æµ‹è¯•
console.log('PayPal Client ID:', process.env.EXPO_PUBLIC_PAYPAL_CLIENT_ID);
console.log('PayPal Mode:', process.env.PAYPAL_MODE);
console.log('Basic Monthly Plan:', process.env.PAYPAL_PLAN_ID_BASIC_MONTHLY);
```

---

## 5. æµ‹è¯• PayPal é›†æˆ

### æ­¥éª¤ 5.1: å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
bun run start
```

### æ­¥éª¤ 5.2: æµ‹è¯•åˆ›å»ºè®¢é˜…

1. **ç™»å½•åº”ç”¨** (ä½¿ç”¨ Supabase Auth)

2. **è®¿é—®è®¢é˜…é¡µé¢**:
   ```
   http://localhost:8081/subscription
   ```
   æˆ–
   ```
   http://localhost:8081/subscription/paypal
   ```

3. **é€‰æ‹©è®¢é˜…è®¡åˆ’**:
   - Basic Monthly ($9.99/æœˆ)
   - Basic Yearly ($99.99/å¹´)
   - Premium Monthly ($19.99/æœˆ)
   - Premium Yearly ($199.99/å¹´)

4. **ç‚¹å‡» "Subscribe" æŒ‰é’®**

5. **åç«¯è°ƒç”¨æµ‹è¯•**:
   
   åº”è¯¥çœ‹åˆ°æ§åˆ¶å°æ—¥å¿—:
   ```
   [createSubscription] Creating PayPal subscription: {...}
   [createSubscription] Subscription created: { id: 'I-xxxxx', status: 'APPROVAL_PENDING' }
   ```

6. **è·³è½¬åˆ° PayPal**:
   
   åº”ç”¨ä¼šè·³è½¬åˆ° PayPal Sandbox ç™»å½•é¡µé¢

7. **ä½¿ç”¨ Sandbox æµ‹è¯•è´¦æˆ·ç™»å½•**:
   - Email: `sb-xxxxx@personal.example.com` (æ­¥éª¤ 2.4)
   - Password: [ä» Sandbox Accounts è·å–]

8. **å®Œæˆè®¢é˜…**:
   - æŸ¥çœ‹è®¢é˜…è¯¦æƒ…
   - ç‚¹å‡» **"Agree & Subscribe"**
   - PayPal ä¼šé‡å®šå‘å›åº”ç”¨

9. **éªŒè¯è®¢é˜…æ¿€æ´»**:
   
   é‡å®šå‘ URL åº”åŒ…å« `subscription_id` å’Œ `ba_token`:
   ```
   http://localhost:8081/subscription/success?subscription_id=I-xxxxx&ba_token=BA-xxxxx
   ```

10. **åç«¯æ¿€æ´»è®¢é˜…**:
    
    åº”ç”¨åº”è°ƒç”¨ `activateSubscription` tRPC æ–¹æ³•:
    ```typescript
    const result = await trpc.paypal.activateSubscription.mutate({
      subscriptionId: 'I-xxxxx'
    });
    ```

11. **éªŒè¯æ•°æ®åº“æ›´æ–°**:
    
    æ‰“å¼€ Supabase SQL Editor:
    ```sql
    SELECT * FROM subscriptions WHERE user_id = 'your-user-id';
    ```
    
    åº”è¯¥çœ‹åˆ°:
    - `paypal_subscription_id`: `I-xxxxx`
    - `status`: `active`
    - `plan_name`: `basic` æˆ– `premium`
    - `started_at`: å½“å‰æ—¶é—´

12. **éªŒè¯ç”¨æˆ·ä¼šå‘˜ç­‰çº§æ›´æ–°**:
    ```sql
    SELECT membership_level, max_devices FROM users WHERE id = 'your-user-id';
    ```
    
    åº”è¯¥çœ‹åˆ°:
    - `membership_level`: `basic` æˆ– `premium`
    - `max_devices`: `3` (basic) æˆ– `5` (premium)

### æ­¥éª¤ 5.3: æµ‹è¯•å–æ¶ˆè®¢é˜…

1. **è®¿é—®ä¼šå‘˜ç®¡ç†é¡µé¢**:
   ```
   http://localhost:8081/settings/account/membership
   ```

2. **ç‚¹å‡» "Cancel Subscription"**

3. **ç¡®è®¤å–æ¶ˆ**

4. **åç«¯è°ƒç”¨æµ‹è¯•**:
   ```
   [cancelSubscription] Cancelling PayPal subscription: I-xxxxx
   [cancelSubscription] Subscription cancelled successfully
   ```

5. **éªŒè¯æ•°æ®åº“æ›´æ–°**:
   ```sql
   SELECT status, cancelled_at FROM subscriptions WHERE paypal_subscription_id = 'I-xxxxx';
   ```
   
   åº”è¯¥çœ‹åˆ°:
   - `status`: `cancelled`
   - `cancelled_at`: å½“å‰æ—¶é—´

6. **éªŒè¯ç”¨æˆ·é™çº§**:
   ```sql
   SELECT membership_level FROM users WHERE id = 'your-user-id';
   ```
   
   åº”è¯¥çœ‹åˆ°:
   - `membership_level`: `free`

### æ­¥éª¤ 5.4: æµ‹è¯• PayPal Webhook (å¯é€‰)

PayPal ä¼šåœ¨è®¢é˜…çŠ¶æ€å˜åŒ–æ—¶å‘é€ webhook é€šçŸ¥ã€‚

1. **é…ç½® Webhook URL** (åœ¨ PayPal App è®¾ç½®ä¸­):
   ```
   https://your-backend.com/api/trpc/paypal.webhook
   ```

2. **è®¢é˜… Webhook äº‹ä»¶**:
   - `BILLING.SUBSCRIPTION.ACTIVATED`
   - `BILLING.SUBSCRIPTION.CANCELLED`
   - `BILLING.SUBSCRIPTION.SUSPENDED`
   - `BILLING.SUBSCRIPTION.EXPIRED`
   - `BILLING.SUBSCRIPTION.PAYMENT.FAILED`

3. **æµ‹è¯• Webhook**:
   - åœ¨ PayPal Developer Dashboard â†’ Webhooks
   - ç‚¹å‡» "Webhook simulator"
   - é€‰æ‹©äº‹ä»¶ç±»å‹å¹¶å‘é€æµ‹è¯• webhook

---

## 6. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### æ­¥éª¤ 6.1: åˆ›å»ºç”Ÿäº§ç¯å¢ƒ App

1. åœ¨ PayPal Developer Dashboard
2. åˆ‡æ¢åˆ° **"Live"** ç¯å¢ƒ (é¡¶éƒ¨åˆ‡æ¢æŒ‰é’®)
3. é‡å¤æ­¥éª¤ 2.1-2.3 åˆ›å»ºç”Ÿäº§ App
4. è·å– **Live Client ID** å’Œ **Live Secret**

### æ­¥éª¤ 6.2: åˆ›å»ºç”Ÿäº§è®¢é˜…è®¡åˆ’

1. ä½¿ç”¨ Live Access Token
2. é‡å¤æ­¥éª¤ 3.2-3.4 åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„äº§å“å’Œè®¡åˆ’
3. **é‡è¦**: ä»·æ ¼å’Œè®¡åˆ’ ID ä¼šä¸ Sandbox ä¸åŒ

### æ­¥éª¤ 6.3: æ›´æ–°ç”Ÿäº§ç¯å¢ƒå˜é‡

```env
# =====================================================
# PayPal Configuration (PRODUCTION)
# =====================================================
EXPO_PUBLIC_PAYPAL_CLIENT_ID=YOUR_LIVE_CLIENT_ID
PAYPAL_CLIENT_SECRET=YOUR_LIVE_SECRET
PAYPAL_MODE=live

# PayPal è®¢é˜…è®¡åˆ’ ID (PRODUCTION)
PAYPAL_PLAN_ID_BASIC_MONTHLY=P-LIVE-1xxxxx
PAYPAL_PLAN_ID_BASIC_YEARLY=P-LIVE-2xxxxx
PAYPAL_PLAN_ID_PREMIUM_MONTHLY=P-LIVE-3xxxxx
PAYPAL_PLAN_ID_PREMIUM_YEARLY=P-LIVE-4xxxxx

# App URL (PRODUCTION)
EXPO_PUBLIC_APP_URL=https://your-production-domain.com
```

### æ­¥éª¤ 6.4: éªŒè¯ PayPal ä¸šåŠ¡è´¦æˆ·

ç”Ÿäº§ç¯å¢ƒéœ€è¦éªŒè¯çš„ PayPal ä¸šåŠ¡è´¦æˆ·:

1. ç™»å½• PayPal.com (ä¸æ˜¯ Developer Portal)
2. å‡çº§åˆ° Business Account
3. å®Œæˆä¸šåŠ¡ä¿¡æ¯éªŒè¯:
   - ä¼ä¸šåç§°
   - ä¼ä¸šåœ°å€
   - ç¨å· (å¦‚é€‚ç”¨)
4. è¿æ¥é“¶è¡Œè´¦æˆ· (ç”¨äºæ¥æ”¶ä»˜æ¬¾)

### æ­¥éª¤ 6.5: é…ç½®æ”¯ä»˜æ¥æ”¶

1. åœ¨ PayPal Business Account è®¾ç½®ä¸­
2. é…ç½®è‡ªåŠ¨æç° (å¯é€‰)
3. è®¾ç½®å‘ç¥¨å’Œæ”¶æ®æ¨¡æ¿

---

## 7. å¸¸è§é—®é¢˜

### Q1: Access Token è·å–å¤±è´¥

**é”™è¯¯**: `401 Unauthorized`

**åŸå› **:
- Client ID æˆ– Secret é”™è¯¯
- ä½¿ç”¨äº† Sandbox å‡­è¯åœ¨ Live ç¯å¢ƒ (æˆ–åä¹‹)

**è§£å†³æ–¹æ¡ˆ**:
```bash
# éªŒè¯å‡­è¯
echo "Client ID: $EXPO_PUBLIC_PAYPAL_CLIENT_ID"
echo "Mode: $PAYPAL_MODE"

# ç¡®ä¿ Client ID å’Œ Mode åŒ¹é…
# Sandbox Client ID ä»¥ A å¼€å¤´
# Live Client ID ä»¥ A å¼€å¤´ (ä½†æ ¼å¼ä¸åŒ)
```

### Q2: åˆ›å»ºè®¢é˜…å¤±è´¥

**é”™è¯¯**: `INVALID_RESOURCE_ID`

**åŸå› **:
- Plan ID ä¸å­˜åœ¨
- Plan æœªæ¿€æ´»
- ä½¿ç”¨äº† Sandbox Plan ID åœ¨ Live ç¯å¢ƒ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# éªŒè¯ Plan çŠ¶æ€
curl -v https://api-m.sandbox.paypal.com/v1/billing/plans/P-xxxxx \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# æ£€æŸ¥å“åº”ä¸­çš„ "status" å­—æ®µï¼Œåº”è¯¥æ˜¯ "ACTIVE"
```

### Q3: PayPal é‡å®šå‘åå‚æ•°ä¸¢å¤±

**é”™è¯¯**: æ²¡æœ‰ `subscription_id` æˆ– `ba_token`

**åŸå› **:
- Return URL é…ç½®é”™è¯¯
- ç”¨æˆ·å–æ¶ˆäº†è®¢é˜…

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ createSubscription tRPC ä¸­æ£€æŸ¥ return_url
console.log('Return URL:', input.returnUrl);

// ç¡®ä¿ return_url æ˜¯å®Œæ•´çš„ URL
const returnUrl = input.returnUrl || 
  `${process.env.EXPO_PUBLIC_APP_URL}/subscription/success`;
```

### Q4: Webhook éªŒè¯å¤±è´¥

**é”™è¯¯**: `WEBHOOK_SIGNATURE_VERIFICATION_FAILED`

**åŸå› **:
- Webhook ç­¾åéªŒè¯å¤±è´¥
- Webhook ID ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åœ¨ webhook route ä¸­æ·»åŠ ç­¾åéªŒè¯
// å‚è€ƒ: https://developer.paypal.com/docs/api/webhooks/v1/#verify-webhook-signature
import crypto from 'crypto';

const verifyWebhook = (headers: Headers, body: string) => {
  const transmissionId = headers.get('PAYPAL-TRANSMISSION-ID');
  const transmissionTime = headers.get('PAYPAL-TRANSMISSION-TIME');
  const transmissionSig = headers.get('PAYPAL-TRANSMISSION-SIG');
  const certUrl = headers.get('PAYPAL-CERT-URL');
  const authAlgo = headers.get('PAYPAL-AUTH-ALGO');
  
  // éªŒè¯é€»è¾‘...
};
```

### Q5: æµ‹è¯•è´¦æˆ·ä½™é¢ä¸è¶³

**é”™è¯¯**: `PAYMENT_FAILURE`

**åŸå› **:
- Sandbox æµ‹è¯•è´¦æˆ·ä½™é¢ä¸º 0

**è§£å†³æ–¹æ¡ˆ**:
1. åœ¨ PayPal Developer Dashboard â†’ Sandbox â†’ Accounts
2. ç‚¹å‡» Personal Account çš„ "..." â†’ "View/Edit Account"
3. åœ¨ "Funding" æ ‡ç­¾ä¸‹ï¼Œç‚¹å‡» "Add Money"
4. æ·»åŠ  $100-1000 æµ‹è¯•ä½™é¢

### Q6: è®¢é˜…è®¡åˆ’ä»·æ ¼æ— æ³•ä¿®æ”¹

**è¯´æ˜**: PayPal è®¢é˜…è®¡åˆ’åˆ›å»ºåï¼Œä»·æ ¼**ä¸èƒ½**ä¿®æ”¹

**è§£å†³æ–¹æ¡ˆ**:
- å¦‚éœ€æ›´æ”¹ä»·æ ¼ï¼Œå¿…é¡»åˆ›å»ºæ–°çš„è®¡åˆ’
- å°†ç”¨æˆ·è¿ç§»åˆ°æ–°è®¡åˆ’
- åºŸå¼ƒæ—§è®¡åˆ’ (è®¾ç½®ä¸º INACTIVE)

---

## ğŸ“Š PayPal è´¹ç”¨è¯´æ˜

### Sandbox æµ‹è¯•
- âœ… **å®Œå…¨å…è´¹**ï¼Œæ— ä»»ä½•è´¹ç”¨

### ç”Ÿäº§ç¯å¢ƒ
PayPal è®¢é˜…æ”¶å–ä»¥ä¸‹è´¹ç”¨:

| åœ°åŒº | äº¤æ˜“è´¹ | å›ºå®šè´¹ç”¨ |
|-----|-------|---------|
| **ç¾å›½** | 2.9% | + $0.30 |
| **æ¬§æ´²** | 2.9% | + â‚¬0.35 |
| **å…¶ä»–åœ°åŒº** | 3.9% | + å›ºå®šè´¹ |

**ç¤ºä¾‹**:
- Basic Monthly ($9.99) â†’ PayPal æ”¶å– $0.59 â†’ ä½ æ”¶åˆ° $9.40
- Premium Yearly ($199.99) â†’ PayPal æ”¶å– $6.10 â†’ ä½ æ”¶åˆ° $193.89

---

## ğŸ“š å‚è€ƒèµ„æº

- **PayPal Subscriptions API**: https://developer.paypal.com/docs/subscriptions/
- **PayPal REST API**: https://developer.paypal.com/api/rest/
- **Webhook Events**: https://developer.paypal.com/api/webhooks/event-names/
- **PayPal Sandbox**: https://developer.paypal.com/dashboard/accounts
- **API Explorer**: https://developer.paypal.com/api/rest/api-explorer/

---

## âœ… è®¾ç½®å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] PayPal å¼€å‘è€…è´¦æˆ·å·²åˆ›å»º
- [ ] Sandbox App å·²åˆ›å»ºï¼ŒClient ID å’Œ Secret å·²è·å–
- [ ] 4 ä¸ªè®¢é˜…è®¡åˆ’å·²åˆ›å»ºå¹¶æ¿€æ´»:
  - [ ] Basic Monthly
  - [ ] Basic Yearly
  - [ ] Premium Monthly
  - [ ] Premium Yearly
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®åˆ° `.env`
- [ ] Sandbox æµ‹è¯•è´¦æˆ·å¯ç”¨
- [ ] åˆ›å»ºè®¢é˜…æµ‹è¯•é€šè¿‡
- [ ] æ¿€æ´»è®¢é˜…æµ‹è¯•é€šè¿‡
- [ ] å–æ¶ˆè®¢é˜…æµ‹è¯•é€šè¿‡
- [ ] æ•°æ®åº“è®¢é˜…è®°å½•æ­£ç¡®
- [ ] ç”¨æˆ·ä¼šå‘˜ç­‰çº§æ­£ç¡®åŒæ­¥
- [ ] (ç”Ÿäº§) Live App å·²åˆ›å»º
- [ ] (ç”Ÿäº§) ç”Ÿäº§è®¢é˜…è®¡åˆ’å·²åˆ›å»º
- [ ] (ç”Ÿäº§) ä¸šåŠ¡è´¦æˆ·å·²éªŒè¯
- [ ] (ç”Ÿäº§) é“¶è¡Œè´¦æˆ·å·²è¿æ¥

---

**è®¾ç½®çŠ¶æ€**: â³ å¾…è®¾ç½®  
**é¢„è®¡æ—¶é—´**: 60-90 åˆ†é’Ÿ  
**éš¾åº¦**: â­â­â­â­ è¾ƒé«˜ (éœ€è¦å¤šæ¬¡ API è°ƒç”¨)

---

## ğŸ’¡ æç¤º

1. **ä¿å­˜æ‰€æœ‰ Plan ID**: å°† Plan ID è®°å½•åœ¨å®‰å…¨çš„åœ°æ–¹ï¼Œä¸¢å¤±åæ— æ³•æ‰¾å›
2. **å®šæœŸæ£€æŸ¥ Webhook**: ç¡®ä¿ webhook æ­£å¸¸æ¥æ”¶å’Œå¤„ç†
3. **ç›‘æ§å¤±è´¥æ”¯ä»˜**: è®¾ç½®é‚®ä»¶æé†’ï¼ŒåŠæ—¶å¤„ç†æ”¯ä»˜å¤±è´¥
4. **æµ‹è¯•é™çº§æµç¨‹**: ç¡®ä¿ç”¨æˆ·å–æ¶ˆè®¢é˜…åæ­£ç¡®é™çº§
5. **å¤‡ä»½ç¯å¢ƒå˜é‡**: ç”Ÿäº§ç¯å¢ƒçš„å‡­è¯è¦å®‰å…¨å¤‡ä»½

ç¥ä½ è®¾ç½®é¡ºåˆ©ï¼ğŸ‰
